set detections {{48600 {id 48600 center {152.609129 318.685574} corners {{144.083054 339.607422} {177.316391 328.516022} {161.283508 297.399811} {127.747101 308.793549}} size 35} 48601 {id 48601 center {239.505994 289.686665} corners {{230.457230 310.851318} {263.627930 299.887329} {248.656937 268.283020} {215.102951 279.367126}} size 34} 48602 {id 48602 center {326.217110 260.961803} corners {{316.766174 282.319702} {349.748718 271.510315} {335.791260 239.325455} {302.332428 250.255020}} size 34} 48603 {id 48603 center {412.366939 232.627536} corners {{402.642670 254.171387} {435.270020 243.529068} {422.318970 210.579086} {389.171967 221.587067}} size 34} 48604 {id 48604 center {497.979401 204.475327} corners {{487.743195 226.290436} {519.930847 215.665955} {508.406036 182.254379} {475.337494 192.932709}} size 33} 48605 {id 48605 center {582.789022 176.373836} corners {{572.099487 198.578384} {604.118286 187.892242} {593.565857 153.987946} {561.122742 164.673431}} size 33} 48606 {id 48606 center {193.581258 397.176756} corners {{184.916031 416.900208} {217.358658 406.088501} {202.341812 377.236328} {169.704041 388.227600}} size 34} 48607 {id 48607 center {277.681474 368.915010} corners {{268.594360 388.739044} {300.785706 378.048584} {286.876221 348.856171} {254.380768 359.703766}} size 33} 48608 {id 48608 center {361.396438 340.806918} corners {{351.928528 360.879059} {383.897552 350.246704} {370.944489 320.564880} {338.744659 331.303925}} size 33} 48609 {id 48609 center {444.529877 313.037882} corners {{434.755188 333.249115} {466.339478 322.828186} {454.446869 292.532410} {422.548645 303.170532}} size 33} 48610 {id 48610 center {527.018758 285.481166} corners {{516.860718 305.976379} {547.990784 295.555267} {537.275940 264.785919} {505.666901 275.224609}} size 32} 48611 {id 48611 center {608.776302 258.142938} corners {{598.260620 278.767212} {629.151428 268.523193} {619.444458 237.219620} {588.184204 247.652145}} size 32} 48612 {id 48612 center {232.169961 470.554274} corners {{223.460251 489.187164} {254.878693 478.529785} {240.994675 451.675354} {209.212814 462.491516}} size 33} 48613 {id 48613 center {313.406517 442.914797} corners {{304.381378 461.580872} {335.449677 451.121918} {322.579346 423.943268} {291.123840 434.618500}} size 32} 48614 {id 48614 center {394.307160 415.421963} corners {{384.951233 434.158691} {415.717072 423.842194} {403.833557 396.343842} {372.647095 406.903351}} size 32} 48615 {id 48615 center {474.569852 388.194624} corners {{464.925018 407.059387} {495.270691 396.844513} {484.417267 368.933624} {453.537811 379.406342}} size 32} 48616 {id 48616 center {554.168911 361.145493} corners {{544.166016 380.282104} {574.182678 370.095612} {564.264709 341.831146} {533.828674 352.049377}} size 31} 48617 {id 48617 center {633.174677 334.408658} corners {{622.791077 353.728119} {652.536194 343.600800} {643.672302 314.877045} {613.450378 325.044281}} size 31} 48618 {id 48618 center {268.432805 539.000396} corners {{259.789307 556.844116} {290.153992 546.223389} {277.132507 521.040649} {246.351135 531.657532}} size 32} 48619 {id 48619 center {346.945320 512.019288} corners {{338.015747 529.727600} {368.072266 519.425781} {356.059021 493.945831} {325.520569 504.508392}} size 31} 48620 {id 48620 center {425.094410 485.092078} corners {{415.853424 502.912445} {445.569672 492.702911} {434.481201 466.990540} {404.341370 477.377991}} size 31} 48621 {id 48621 center {502.657446 458.390618} corners {{493.077850 476.284210} {522.402222 466.215088} {512.338135 440.308197} {482.682678 450.475006}} size 31} 48622 {id 48622 center {579.564539 431.996797} corners {{569.787415 449.869141} {598.682129 440.045105} {589.545959 413.751007} {560.186340 423.838776}} size 30} 48623 {id 48623 center {655.922417 405.802572} corners {{645.783997 423.836426} {674.546692 414.105042} {666.214722 387.494995} {637.108765 397.415680}} size 30}} {48600 {id 48600 center {133.303662 430.543872} corners {{124.251167 456.096222} {161.130997 437.967987} {142.322372 405.086884} {105.050331 423.006104}} size 41} 48601 {id 48601 center {228.659878 384.248314} corners {{219.983841 408.922699} {254.996094 391.855530} {237.205704 359.944244} {201.963654 376.537109}} size 38} 48602 {id 48602 center {318.352352 341.040753} corners {{310.336517 364.731445} {343.268219 348.721466} {326.294769 317.567047} {293.357208 333.335602}} size 36} 48603 {id 48603 center {402.500585 300.569163} corners {{395.115143 323.350464} {425.741821 308.344940} {409.821350 277.987366} {378.974152 292.697968}} size 34} 48604 {id 48604 center {481.338011 262.667477} corners {{474.477051 284.556183} {502.961975 270.488739} {488.133209 240.988571} {459.185333 254.654984}} size 31} 48605 {id 48605 center {555.182670 226.982074} corners {{548.793518 248.090805} {575.637695 234.915848} {561.490967 206.140472} {534.372620 218.910599}} size 29} 48606 {id 48606 center {183.160070 516.728052} corners {{174.424744 542.173096} {210.268188 523.156189} {191.880432 491.326599} {155.605560 510.194061}} size 40} 48607 {id 48607 center {275.731621 468.279424} corners {{267.384613 492.850769} {301.194885 474.812317} {283.988159 443.974396} {249.798706 461.626038}} size 38} 48608 {id 48608 center {362.844224 422.934322} corners {{355.049133 446.606323} {386.847168 429.767731} {370.588684 399.416077} {338.326019 415.954224}} size 35} 48609 {id 48609 center {444.320552 380.358139} corners {{437.103363 403.017456} {466.868835 387.332428} {451.503906 357.805054} {421.435425 373.279663}} size 33} 48610 {id 48610 center {520.708493 340.452597} corners {{514.051208 362.242767} {541.786743 347.558929} {527.316589 318.823425} {499.276733 333.227081}} size 31} 48611 {id 48611 center {592.377662 302.987235} corners {{586.186890 323.900269} {612.179077 310.214783} {598.547913 282.143524} {572.306152 295.661102}} size 29} 48612 {id 48612 center {231.692529 600.190394} corners {{223.168930 625.523010} {258.062042 605.885315} {240.173737 574.983765} {205.059387 594.438538}} size 40} 48613 {id 48613 center {321.453505 549.776208} corners {{313.304474 574.432983} {346.191589 555.562073} {329.477081 525.499023} {296.229828 543.876770}} size 37} 48614 {id 48614 center {405.763761 502.357943} corners {{398.172607 526.000916} {429.044556 508.303864} {413.301819 478.880341} {382.063538 496.304901}} size 35} 48615 {id 48615 center {484.823594 457.862374} corners {{477.830078 480.577179} {506.645782 464.016876} {491.754669 435.350372} {462.628357 451.602661}} size 33} 48616 {id 48616 center {558.916894 416.127904} corners {{552.419617 437.847168} {579.355164 422.527893} {565.371887 394.549988} {538.156982 409.627197}} size 30} 48617 {id 48617 center {628.533364 376.867531} corners {{622.500305 397.842499} {647.853333 383.370117} {634.475525 356.208588} {608.974609 370.284576}} size 29} 48618 {id 48618 center {278.845558 680.962630} corners {{270.685760 706.162048} {304.185211 685.665405} {286.969177 655.874939} {253.084793 676.181702}} size 39} 48619 {id 48619 center {365.656598 628.873715} corners {{357.916565 653.191223} {389.593384 633.892395} {373.344604 604.719666} {341.252319 623.757019}} size 37} 48620 {id 48620 center {447.325577 579.622730} corners {{439.992615 603.143372} {469.952454 584.836060} {454.592712 556.313232} {424.382507 574.336548}} size 35} 48621 {id 48621 center {524.061428 533.332506} corners {{517.220459 555.975891} {545.184204 538.818420} {530.835388 510.910919} {502.497650 527.732056}} size 32} 48622 {id 48622 center {595.971802 489.881562} corners {{589.692261 511.602875} {615.840515 495.580048} {602.225952 468.248077} {575.849731 484.110413}} size 30} 48623 {id 48623 center {663.671406 449.014201} corners {{657.815857 469.894531} {682.417664 454.909393} {669.487610 428.274170} {644.752441 443.064697}} size 28}} {48600 {id 48600 center {133.568878 159.714438} corners {{123.324265 179.198380} {156.876495 173.080353} {144.010223 139.856339} {110.091316 146.251068}} size 34} 48601 {id 48601 center {222.359879 143.327843} corners {{211.329926 162.944565} {245.068649 157.011978} {233.558838 123.410545} {199.441925 129.517654}} size 34} 48602 {id 48602 center {311.977646 127.137406} corners {{300.297974 147.033554} {334.024506 140.877884} {323.762268 107.062477} {289.576843 113.176338}} size 34} 48603 {id 48603 center {401.899926 111.135025} corners {{389.527039 131.172180} {423.239471 125.025414} {414.524323 90.690567} {380.118713 96.957146}} size 34} 48604 {id 48604 center {491.909577 95.081777} corners {{478.813538 115.226974} {512.719666 109.313957} {505.313324 74.463242} {471.008209 80.787170}} size 34} 48605 {id 48605 center {582.218435 78.922529} corners {{568.280151 99.292053} {602.113220 93.157494} {596.394897 58.204929} {561.985291 64.445465}} size 34} 48606 {id 48606 center {167.127098 243.953476} corners {{156.996689 261.879974} {189.310577 256.148712} {177.427826 225.725586} {144.613266 231.576630}} size 32} 48607 {id 48607 center {252.653992 228.524885} corners {{241.883820 246.673950} {274.478271 240.970413} {263.542267 210.176804} {230.707413 216.009613}} size 33} 48608 {id 48608 center {338.819836 213.326627} corners {{327.358246 231.595215} {359.842102 225.847763} {350.431915 194.818176} {317.408356 200.573669}} size 32} 48609 {id 48609 center {425.035263 198.139195} corners {{412.929718 216.481247} {445.397125 210.843582} {437.426910 179.363647} {404.367493 185.243942}} size 32} 48610 {id 48610 center {511.343612 182.868826} corners {{498.518982 201.469040} {530.995422 195.711838} {524.322327 164.045135} {491.353302 169.804596}} size 32} 48611 {id 48611 center {597.690844 167.611291} corners {{584.191467 186.314117} {616.576050 180.555939} {611.410889 148.602737} {578.339661 154.347244}} size 32} 48612 {id 48612 center {198.425407 321.520176} corners {{188.370758 338.109955} {219.578125 332.606293} {208.643509 304.660706} {176.818665 310.196106}} size 31} 48613 {id 48613 center {280.747047 306.915437} corners {{270.123962 323.630676} {301.479614 318.208893} {291.532837 289.944183} {259.797607 295.503845}} size 31} 48614 {id 48614 center {363.475612 292.314266} corners {{352.224487 309.234131} {383.549255 303.720703} {374.816345 275.259644} {343.164978 280.773163}} size 31} 48615 {id 48615 center {446.241720 277.831367} corners {{434.425018 294.819885} {465.620728 289.333923} {458.247375 260.571198} {426.537079 266.135529}} size 31} 48616 {id 48616 center {528.965946 263.273716} corners {{516.494202 280.445953} {547.677307 274.953705} {541.564331 245.927109} {510.048676 251.465195}} size 31} 48617 {id 48617 center {611.696288 248.720973} corners {{598.626587 265.973602} {629.752686 260.464874} {624.980164 231.185623} {593.339844 236.781921}} size 31} 48618 {id 48618 center {227.480917 392.911484} corners {{217.537521 408.294708} {247.586899 402.970734} {237.565689 377.309540} {206.729156 382.529144}} size 30} 48619 {id 48619 center {306.680456 378.962147} corners {{296.190186 394.429688} {326.387695 389.196472} {317.380127 363.185852} {286.690308 368.580902}} size 30} 48620 {id 48620 center {386.158309 364.971590} corners {{375.160889 380.570679} {405.310455 375.357483} {397.298828 349.169525} {366.784485 354.465485}} size 30} 48621 {id 48621 center {465.686864 351.045241} corners {{454.165680 366.738678} {484.188324 361.518250} {477.407288 335.080414} {446.958710 340.443909}} size 30} 48622 {id 48622 center {545.141941 337.103842} corners {{533.025208 352.967224} {562.939453 347.671936} {557.382202 321.078735} {527.042419 326.356415}} size 30} 48623 {id 48623 center {624.520706 323.188503} corners {{611.891235 339.095306} {641.746399 333.896790} {637.357483 307.020599} {607.041321 312.322510}} size 30}} {48600 {id 48600 center {149.515848 200.572366} corners {{145.912674 219.108292} {172.727341 213.925110} {153.212219 181.557007} {126.399338 187.274261}} size 27} 48601 {id 48601 center {223.121305 185.721546} corners {{218.163956 205.072067} {247.040695 199.499954} {228.291718 165.539352} {198.817169 171.721512}} size 29} 48602 {id 48602 center {302.966191 169.573449} corners {{296.357941 190.071655} {327.797455 184.161697} {309.821350 148.309357} {278.077057 154.951202}} size 31} 48603 {id 48603 center {389.838120 152.254678} corners {{381.332886 173.898926} {415.405701 167.614304} {398.692841 129.721054} {364.157990 136.827438}} size 34} 48604 {id 48604 center {484.360957 133.517592} corners {{473.712830 156.619415} {510.691895 149.599380} {495.370575 109.631493} {457.881897 117.345337}} size 37} 48605 {id 48605 center {587.456406 113.098701} corners {{574.244751 137.540482} {614.498718 130.034256} {601.264038 87.554352} {560.181641 96.017570}} size 40} 48606 {id 48606 center {199.212233 282.072797} corners {{195.018982 298.274506} {221.246689 294.561737} {203.562881 265.262939} {177.140366 269.562653}} size 26} 48607 {id 48607 center {271.160788 271.014809} corners {{265.664215 288.067200} {293.960541 283.974762} {276.835266 253.410492} {248.317413 258.030060}} size 28} 48608 {id 48608 center {348.869893 259.209574} corners {{341.830109 277.087677} {372.172729 272.688080} {356.162140 240.690323} {325.305511 245.579788}} size 30} 48609 {id 48609 center {432.677571 246.518838} corners {{423.931152 265.258759} {456.600555 260.599731} {441.753540 227.072830} {408.399994 232.229233}} size 32} 48610 {id 48610 center {523.304276 232.746309} corners {{512.516907 252.639664} {547.979187 247.536636} {534.475281 212.145477} {498.478912 217.865799}} size 35} 48611 {id 48611 center {621.674890 217.759226} corners {{608.583679 238.740356} {646.923706 233.187225} {635.280090 195.954330} {596.127930 202.149048}} size 38} 48612 {id 48612 center {244.749471 355.756738} corners {{240.014740 370.094330} {265.657776 367.446198} {249.621933 341.002075} {223.703308 343.990204}} size 25} 48613 {id 48613 center {314.857368 347.871027} corners {{308.932556 362.796478} {336.419952 359.981750} {320.974030 332.462280} {293.165649 335.687775}} size 27} 48614 {id 48614 center {390.167234 339.422328} corners {{382.792786 355.086761} {412.289063 352.012634} {397.733978 323.349426} {367.795227 326.689636}} size 29} 48615 {id 48615 center {470.964171 330.421334} corners {{462.086517 346.670258} {493.673004 343.523071} {480.213318 313.492462} {448.163483 317.266602}} size 31} 48616 {id 48616 center {557.914286 320.621398} corners {{547.161865 337.755646} {581.140930 334.322876} {569.085327 302.820068} {534.845276 307.012909}} size 34} 48617 {id 48617 center {651.956704 310.121220} corners {{639.153748 328.192383} {675.715332 324.372986} {665.260925 291.342529} {628.097839 295.809326}} size 36} 48618 {id 48618 center {286.449791 422.505350} corners {{281.369507 435.179169} {306.365173 433.467438} {291.649109 409.534576} {266.304840 411.416901}} size 25} 48619 {id 48619 center {354.555035 417.210843} corners {{348.308563 430.367889} {375.167206 428.621399} {361.009155 403.616425} {334.143097 405.911133}} size 26} 48620 {id 48620 center {427.447054 411.553103} corners {{419.859344 425.292786} {448.540955 423.387054} {435.255493 397.413727} {406.448395 399.772583}} size 28} 48621 {id 48621 center {505.446163 405.609407} corners {{496.452606 419.873657} {526.864868 417.789825} {514.833801 390.720123} {483.908051 393.361084}} size 30} 48622 {id 48622 center {589.162341 399.214980} corners {{578.554382 414.184692} {610.906982 411.884857} {600.184753 383.660400} {567.138123 386.382202}} size 32} 48623 {id 48623 center {679.217699 392.282138} corners {{666.598022 408.022675} {701.591309 405.483521} {692.175659 376.119659} {656.659851 378.972046}} size 35}}}

set Hs {{
    {0.0001829450187964888 -9.738523943224792e-5 0.006701237910856626}
    {-7.990322862312005e-5 -0.0002321750676117069 0.15004332467254408}
    {-0.00013808165954797442 -0.0003079663551611336 1}
} {
    {0.00016160772226993578 -9.453435456715562e-5 0.023011664302994273}
    {-0.00011888969757935847 -0.00019482652452103812 0.16976084570593733}
    {-0.0003319704737366541 2.2683861588653175e-5 1}
} {
    {0.0002071658940723003 -8.494458832696975e-5 -0.010383929145096482}
    {-4.461074806269899e-5 -0.00025436565822202484 0.1135606636925045}
    {-5.938918848873381e-5 -0.0004317725843229451 1}
} {
    {0.00024233013001322782 -0.0001514852670925817 -0.0022610765639750744}
    {-1.8869437225934035e-5 -0.00026702057196421154 0.12151107486291876}
    {0.0003260753996351157 -0.0007540645635611943 1}
}}


namespace eval Evaluator { source "lib/environment.tcl" }
source "lib/language.tcl"

lappend auto_path "./vendor"
package require math::linearalgebra
rename ::scale scaleTk
namespace import ::math::linearalgebra::*

fn processHomography {H} {
    fn h {i j} { getelem $H [- $j 1] [- $i 1] }

    fn v {i j} {
        list \
            [* [h $i 1] [h $j 1]] \
            [+ [* [h $i 1] [h $j 2]] [* [h $i 2] [h $j 1]]] \
            [* [h $i 2] [h $j 2]] \
            [+ [* [h $i 3] [h $j 1]] [* [h $i 1] [h $j 3]]] \
            [+ [* [h $i 3] [h $j 2]] [* [h $i 2] [h $j 3]]] \
            [* [h $i 3] [h $j 3]]
    }
    # TODO: How do I check v_{ij}?

    set V [list \
               [v 1 2] \
               [sub [v 1 1] [v 2 2]]]
    return $V
}

# Draw detections:
package require Tk
canvas .canv -width 1280 -height 720 -background white
set detectionButtons [lmap {i detection} [lenumerate $detections] {
    button .detection$i -text detection$i -command [list apply {{detection} {
        set ROWS 4
        set COLS 6

        .canv delete all
        .canv create rectangle 4 4 [- 1280 2] [- 720 2] -outline blue
        dict for {id tag} $detection {
            set corners [dict get $tag corners]
            .canv create line {*}[join $corners] {*}[lindex $corners 0]
        }

        fn drawDetectionTagCorner {row col corner label} {
            fn detectionTagCorner {row col corner} {
                set id [expr {48600 + $row*$COLS + $col}]
                return [lindex [dict get [dict get $detection $id] corners] $corner]
            }
            .canv create oval \
                {*}[detectionTagCorner $row $col $corner] \
                {*}[add [detectionTagCorner $row $col $corner] {5 5}] \
                -fill red
            .canv create text [detectionTagCorner $row $col $corner] \
                -text $label
        }

        drawDetectionTagCorner 0 0 3 TL
        drawDetectionTagCorner 0 [- $COLS 1] 2 TR
        drawDetectionTagCorner [- $ROWS 1] [- $COLS 1] 1 BR
        drawDetectionTagCorner [- $ROWS 1] 0 0 BL
    }} $detection]
}]
set homButtons [lmap {i H} [lenumerate $Hs] {
    button .h$i -text H$i -command [list apply {{detection H} {
        .canv delete all
        .canv create rectangle 4 4 [- 1280 2] [- 720 2] -outline red
        dict for {id tag} $detection {
            set corners [lmap corner [dict get $tag corners] {
                set corner [list {*}$corner 1]
                set corner [matmul $H $corner]
                lassign $corner cx cy cz
                list [* [/ $cx $cz] 1000] [* [/ $cy $cz] 1000]
            }]
            .canv create line {*}[join $corners] {*}[lindex $corners 0]
        }
    }} [lindex $detections $i] $H]
}]
pack .canv {*}$detectionButtons {*}$homButtons -fill both -expand true

try {
    # Construct V:
    set Vtop [list]; set Vbottom [list]
    foreach H $Hs {
        lassign [processHomography $H] Vtop_ Vbottom_
        lappend Vtop $Vtop_
        lappend Vbottom $Vbottom_
    }
    set V [list {*}$Vtop {*}$Vbottom]
    assert {[shape $V] eq [list [* 2 [llength $Hs]] 6]}

    # Solve Vb = 0:
    lassign [determineSVD [matmul [transpose $V] $V]] U S V'
    set b [lindex [transpose ${V'}] [lindex [lsort -real -indices $S] 0]]

    # Compute camera intrinsic matrix A:
    lassign $b B11 B12 B22 B13 B23 B33
    set v0 [expr {($B12*$B13 - $B11*$B23) / ($B11*$B22 - $B12*$B12)}]
    set lambda [expr {$B33 - ($B13*$B13 + $v0*($B12*$B13 - $B11*$B23))/$B11}]
    set alpha [expr {sqrt($lambda/$B11)}]
    set beta [expr {sqrt($lambda*$B11/($B11*$B22 - $B12*$B12))}]
    set gamma [expr {-$B12*$alpha*$alpha*$beta/$lambda}]
    set u0 [expr {$gamma*$v0/$beta - $B13*$alpha*$alpha/$lambda}]

    foreach var {v0 lambda alpha beta gamma u0} {
        puts "$var = [set $var]"
    }
} on error e {
    puts stderr $::errorInfo
}

vwait forever
