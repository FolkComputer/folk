set detections {
    {48600 {id 48600 center {338.345808 214.503841} corners {{313.625244 232.598892} {356.205963 240.929001} {363.443085 196.133041} {320.592987 188.237488}} size 43} 48601 {id 48601 center {450.863670 235.694190} corners {{425.083740 254.188324} {469.168732 262.637573} {476.879608 217.030746} {432.692963 208.948563}} size 44} 48602 {id 48602 center {565.339382 257.228229} corners {{538.665710 275.803375} {583.815247 284.577087} {592.423706 238.367111} {546.929321 229.976776}} size 45} 48603 {id 48603 center {682.369517 279.098489} corners {{654.669312 297.947754} {700.886719 306.580719} {710.185547 260.170410} {663.787964 251.520752}} size 47} 48604 {id 48604 center {802.104691 301.513266} corners {{773.715881 320.446716} {820.573914 329.251221} {830.731873 282.420837} {783.522034 273.604950}} size 47} 48605 {id 48605 center {925.114025 324.430886} corners {{895.934692 343.318237} {943.822937 352.331482} {954.723694 305.264984} {906.392578 296.511597}} size 48} 48606 {id 48606 center {320.377078 328.107203} corners {{296.010834 345.579956} {338.137665 354.235748} {345.020569 310.435638} {302.823212 302.282776}} size 43} 48607 {id 48607 center {431.247426 350.109734} corners {{405.831329 367.790771} {449.255524 376.600006} {456.858978 332.292725} {413.253571 323.640411}} size 44} 48608 {id 48608 center {543.986483 372.589232} corners {{517.651001 390.412720} {562.167664 399.402466} {570.595398 354.580688} {525.657227 345.557617}} size 45} 48609 {id 48609 center {659.034645 395.461900} corners {{632.003601 413.431641} {677.440369 422.702026} {686.463379 377.227783} {640.748291 368.398437}} size 46} 48610 {id 48610 center {776.965909 418.996198} corners {{749.149048 437.009796} {795.315857 446.412811} {805.026733 400.824615} {758.647644 391.626923}} size 47} 48611 {id 48611 center {898.053903 443.289489} corners {{869.370911 461.274078} {916.572876 470.881348} {927.086304 425.085815} {879.517029 415.670959}} size 48} 48612 {id 48612 center {302.691471 438.851835} corners {{278.701813 455.518951} {320.133942 464.429993} {326.978363 421.978210} {285.408997 413.508301}} size 42} 48613 {id 48613 center {411.996596 461.638929} corners {{387.012726 478.449982} {429.735413 487.614624} {437.359619 444.572754} {394.310822 435.740906}} size 43} 48614 {id 48614 center {523.049360 484.916423} corners {{497.286896 501.846863} {541.019775 511.248657} {549.150757 467.763245} {505.136017 458.667816}} size 44} 48615 {id 48615 center {636.462055 508.761277} corners {{609.804199 525.880859} {654.542419 535.561646} {663.231018 491.570343} {618.621582 482.316498}} size 45} 48616 {id 48616 center {752.516827 533.586486} corners {{725.270386 550.601318} {770.566589 560.473022} {780.133301 516.340576} {734.405090 506.607635}} size 46} 48617 {id 48617 center {871.742751 559.125997} corners {{843.534363 576.185181} {889.949036 586.274475} {900.120056 541.964661} {853.429199 531.817566}} size 47} 48618 {id 48618 center {285.310609 547.012141} corners {{261.896240 562.938538} {302.471405 571.950989} {309.210052 530.755798} {268.148895 522.071960}} size 41} 48619 {id 48619 center {393.059006 570.550304} corners {{368.656555 586.648926} {410.414581 595.886353} {417.894196 554.166199} {375.626862 545.102478}} size 42} 48620 {id 48620 center {502.625278 594.614975} corners {{477.374634 610.809753} {520.258362 620.492676} {528.254822 578.177185} {485.049316 568.821106}} size 43} 48621 {id 48621 center {614.369834 619.486268} corners {{588.353333 635.834473} {632.152100 645.783752} {640.614014 602.994995} {596.655334 593.289001}} size 44} 48622 {id 48622 center {728.724193 645.328657} corners {{701.870178 661.617371} {746.489319 671.776550} {755.796204 628.907715} {710.904236 618.799133}} size 45} 48623 {id 48623 center {845.984200 671.987420} corners {{818.363525 688.238037} {863.887634 698.690979} {873.830383 655.604126} {828.083435 645.287842}} size 46}}
    {48600 {id 48600 center {363.522688 348.667417} corners {{345.081787 369.143250} {384.419617 367.830994} {382.025177 328.123199} {342.738312 329.607056}} size 39} 48601 {id 48601 center {464.572618 345.329318} corners {{445.710236 365.962646} {485.450317 364.637207} {483.511139 324.612701} {443.690491 326.017334}} size 39} 48602 {id 48602 center {565.635215 341.860995} corners {{546.202881 362.645386} {586.273865 361.389679} {584.954651 321.197357} {544.960083 322.297791}} size 40} 48603 {id 48603 center {666.940236 338.460924} corners {{647.515381 359.317627} {687.558044 357.917786} {686.234863 317.744049} {646.249146 318.934906}} size 40} 48604 {id 48604 center {768.412898 335.123857} corners {{748.920227 355.887299} {788.725464 354.500092} {788.015930 314.242859} {748.109192 315.756073}} size 39} 48605 {id 48605 center {870.752089 331.563831} corners {{850.802979 352.286438} {890.799377 350.971466} {890.536804 311.011993} {850.689758 312.141632}} size 40} 48606 {id 48606 center {369.426569 448.816653} corners {{351.079803 468.732666} {390.019012 467.606903} {387.899231 428.763977} {348.944855 430.127441}} size 38} 48607 {id 48607 center {469.440580 445.479606} corners {{450.759430 465.504822} {490.056305 464.277985} {488.187195 425.384216} {448.857269 426.710785}} size 39} 48608 {id 48608 center {569.259259 442.107745} corners {{550.324768 462.119049} {590.013672 461.187103} {588.292480 421.992096} {548.746216 423.250275}} size 39} 48609 {id 48609 center {669.739532 438.836402} corners {{650.547852 459.109314} {689.934937 457.695526} {688.850708 418.648529} {649.417053 419.858612}} size 39} 48610 {id 48610 center {770.324917 435.585093} corners {{750.951538 455.727814} {790.285400 454.437561} {789.689392 415.451630} {750.287415 416.659882}} size 39} 48611 {id 48611 center {871.470199 432.404488} corners {{851.954285 452.405701} {891.488586 451.379089} {891.237061 412.146088} {851.607849 413.577789}} size 39} 48612 {id 48612 center {375.352163 547.013824} corners {{357.274109 566.372620} {395.706177 565.164551} {393.525116 527.553406} {355.008484 528.872314}} size 38} 48613 {id 48613 center {474.342092 543.692288} corners {{456.088135 563.150696} {494.653717 561.795105} {492.929108 523.878845} {453.940216 525.509033}} size 38} 48614 {id 48614 center {573.373172 540.294417} corners {{554.690186 559.803711} {593.668762 558.592224} {592.222534 520.611389} {553.168945 522.078979}} size 38} 48615 {id 48615 center {672.668493 537.096824} corners {{653.780518 556.628662} {692.671509 555.447449} {691.549133 517.572571} {652.611206 518.696411}} size 38} 48616 {id 48616 center {772.346373 534.134204} corners {{753.377991 553.691650} {792.192871 552.404541} {791.441589 514.445984} {752.335144 515.712219}} size 38} 48617 {id 48617 center {872.686163 531.160782} corners {{853.446106 550.705444} {892.306519 549.585144} {891.899963 511.642792} {852.901917 512.582520}} size 38} 48618 {id 48618 center {381.329682 643.353926} corners {{363.623718 662.252563} {401.404114 660.977539} {399.227692 624.250305} {361.252716 625.728088}} size 37} 48619 {id 48619 center {479.367394 639.815207} corners {{461.221008 658.763123} {499.458618 657.556396} {497.611145 620.765625} {459.323883 622.116150}} size 38} 48620 {id 48620 center {577.519051 636.533096} corners {{559.095215 655.598877} {597.417236 654.296265} {595.960022 617.449585} {557.483337 618.647156}} size 38} 48621 {id 48621 center {675.658975 633.457745} corners {{657.177368 652.376343} {695.486755 651.257202} {694.390198 614.283630} {655.839600 615.665833}} size 38} 48622 {id 48622 center {774.561491 630.625663} corners {{755.663147 649.689270} {794.076233 648.554688} {793.401611 611.620789} {754.876099 612.539856}} size 38} 48623 {id 48623 center {873.695122 627.921400} corners {{854.797424 646.859009} {893.144165 645.806580} {892.656860 608.919617} {854.182068 609.977356}} size 38}}
    {48600 {id 48600 center {423.682431 160.046168} corners {{405.829926 185.788498} {451.006226 183.569977} {442.018890 133.606003} {396.206970 136.391785}} size 45} 48601 {id 48601 center {548.417479 153.183831} corners {{527.768494 180.010239} {576.186218 177.662064} {569.713562 125.516739} {520.562378 128.629471}} size 48} 48602 {id 48602 center {682.127804 145.689647} corners {{658.473877 173.569122} {710.427734 171.048645} {706.689026 116.740799} {653.590210 120.117683}} size 52} 48603 {id 48603 center {826.318661 137.187069} corners {{799.059143 166.387970} {855.361145 163.496170} {854.523804 106.973198} {797.114197 110.731232}} size 56} 48604 {id 48604 center {982.475024 128.090705} corners {{951.231567 158.469360} {1012.366577 155.341553} {1014.816162 96.644753} {952.280518 100.563667}} size 61} 48605 {id 48605 center {1150.887864 118.770156} corners {{1115.648315 150.238770} {1181.306152 147.114212} {1187.371826 86.190292} {1120.212524 90.186577}} size 65} 48606 {id 48606 center {446.566568 284.521699} corners {{429.186584 307.003876} {472.375763 306.377441} {464.491760 261.334259} {420.467987 262.420898}} size 43} 48607 {id 48607 center {565.568721 282.126798} corners {{545.703186 305.473389} {591.896545 304.893158} {586.129578 257.963043} {539.074219 259.216309}} size 46} 48608 {id 48608 center {692.825622 279.320702} corners {{670.098694 303.583984} {719.680542 302.832764} {716.241882 254.321487} {665.997925 255.832474}} size 49} 48609 {id 48609 center {829.696576 276.543485} corners {{803.812317 301.822418} {857.021545 300.766479} {856.366882 250.496887} {802.099426 252.079208}} size 53} 48610 {id 48610 center {977.508451 273.369794} corners {{947.991211 299.511444} {1005.489014 298.679840} {1008.145508 246.236389} {949.336975 247.887054}} size 57} 48611 {id 48611 center {1136.880283 270.294544} corners {{1103.753784 297.304626} {1165.251953 296.481323} {1171.305420 242.225601} {1108.270630 243.888107}} size 61} 48612 {id 48612 center {467.208785 397.099758} corners {{450.322723 416.880035} {491.765961 417.694885} {484.626099 376.697174} {442.510284 376.386108}} size 41} 48613 {id 48613 center {581.082223 398.396731} corners {{561.995667 418.700348} {606.015076 419.644257} {600.830078 377.389648} {555.927551 376.960175}} size 44} 48614 {id 48614 center {702.516002 399.747927} corners {{680.875549 420.831268} {727.862244 421.695953} {724.897522 377.942596} {676.950195 377.609772}} size 46} 48615 {id 48615 center {832.469108 401.325627} corners {{807.941101 423.032898} {858.306213 423.975189} {857.800720 378.907166} {806.415527 378.486298}} size 50} 48616 {id 48616 center {972.497756 403.329532} corners {{944.768799 425.733063} {999.231750 426.858612} {1001.469299 379.922058} {945.904602 379.924408}} size 54} 48617 {id 48617 center {1123.198120 405.470031} corners {{1092.248657 428.522064} {1150.096436 429.908295} {1155.628906 381.314667} {1096.416260 381.137573}} size 57} 48618 {id 48618 center {486.003470 499.490579} corners {{469.428162 517.052490} {509.214905 518.659973} {502.959198 481.525604} {462.464874 480.050995}} size 39} 48619 {id 48619 center {595.181075 503.721893} corners {{576.731750 521.622192} {618.931580 523.548767} {614.223206 485.246429} {571.363342 483.838898}} size 42} 48620 {id 48620 center {711.280771 508.547757} corners {{690.580811 526.861389} {735.380249 529.046814} {732.686646 489.609589} {687.005249 487.898956}} size 44} 48621 {id 48621 center {835.378222 514.000443} corners {{812.099304 532.812317} {860.044373 535.192871} {859.459595 494.540100} {810.483643 492.611755}} size 48} 48622 {id 48622 center {968.459725 520.023521} corners {{942.140442 539.334717} {993.556274 541.987244} {995.664490 500.062622} {943.182251 497.901459}} size 51} 48623 {id 48623 center {1111.064009 526.390569} corners {{1081.670044 546.287537} {1136.325684 549.031860} {1141.423462 505.840057} {1085.690674 503.649200}} size 54}}
    {48600 {id 48600 center {157.648636 252.088744} corners {{130.142303 282.619904} {192.650009 280.671234} {185.392090 221.294388} {121.924904 222.916367}} size 62} 48601 {id 48601 center {320.500605 247.354493} corners {{293.006317 277.188721} {352.976898 275.337555} {348.394073 217.087112} {287.138672 218.608322}} size 59} 48602 {id 48602 center {476.423745 242.846117} corners {{449.044617 272.121735} {506.291870 270.254486} {503.990845 213.369507} {445.786163 214.731659}} size 57} 48603 {id 48603 center {625.486142 238.282546} corners {{598.240112 267.005249} {653.018982 265.048676} {652.820679 209.466537} {597.320557 210.901291}} size 54} 48604 {id 48604 center {768.939111 233.892197} corners {{741.662781 262.065643} {794.612366 260.162231} {796.327820 205.602676} {742.714478 207.057968}} size 52} 48605 {id 48605 center {907.490243 229.449254} corners {{880.284790 257.036011} {931.262939 255.275345} {934.854370 201.701599} {883.219299 203.081879}} size 51} 48606 {id 48606 center {177.364646 403.004023} corners {{150.989883 431.691284} {210.668091 428.596039} {204.019806 374.011780} {143.339111 376.857117}} size 59} 48607 {id 48607 center {333.814893 395.238301} corners {{307.352936 423.398804} {364.727661 420.373962} {360.581207 366.753906} {302.075592 369.430573}} size 57} 48608 {id 48608 center {483.512658 387.734374} corners {{457.268097 415.371399} {512.138000 412.482361} {509.961151 359.882599} {454.246643 362.432495}} size 54} 48609 {id 48609 center {626.974652 380.664400} corners {{600.762207 407.821808} {653.485413 404.953308} {653.362244 353.325531} {599.878845 355.839478}} size 52} 48610 {id 48610 center {765.280203 373.935721} corners {{739.142578 400.475769} {789.923096 397.768219} {791.687073 347.122284} {739.951538 349.440002}} size 50} 48611 {id 48611 center {899.007810 367.394162} corners {{872.854065 393.400299} {921.961548 390.887024} {925.406982 341.143982} {875.504517 343.338837}} size 49} 48612 {id 48612 center {195.630241 542.574080} corners {{170.320663 569.646179} {227.378708 565.623596} {221.200272 515.223389} {163.169327 519.007324}} size 57} 48613 {id 48613 center {345.904507 532.184038} corners {{320.432861 558.872681} {375.282593 554.844238} {371.717163 505.138092} {315.654053 508.850952}} size 54} 48614 {id 48614 center {489.952512 522.114047} corners {{464.665527 548.379150} {517.420349 544.598145} {515.526672 495.550659} {461.945160 499.188324}} size 52} 48615 {id 48615 center {628.329429 512.835221} corners {{603.133850 538.540710} {653.828979 534.954285} {653.718750 486.932068} {602.243469 490.207489}} size 50} 48616 {id 48616 center {761.754766 504.039840} corners {{736.425232 529.236450} {785.658630 525.915161} {787.234009 478.694305} {737.384705 481.737885}} size 49} 48617 {id 48617 center {891.103028 495.772140} corners {{865.868286 520.504639} {913.369202 517.283875} {916.457397 470.922394} {868.382813 473.821747}} size 47} 48618 {id 48618 center {212.582941 672.012451} corners {{188.217224 697.643372} {242.859665 692.848145} {237.189682 646.127991} {181.646622 650.722839}} size 54} 48619 {id 48619 center {357.020308 659.485079} corners {{332.674316 684.878357} {385.177368 679.848877} {381.594757 633.853516} {327.894745 638.420837}} size 52} 48620 {id 48620 center {495.790012 647.364519} corners {{471.336121 672.236328} {522.237793 667.883606} {520.471313 622.261414} {468.948364 626.539856}} size 51} 48621 {id 48621 center {629.465560 636.222819} corners {{605.132446 660.581543} {653.986023 656.410522} {654.075989 611.586487} {604.287720 615.493896}} size 49} 48622 {id 48622 center {758.590052 625.707399} corners {{734.287415 649.643250} {781.617554 645.781921} {783.050903 601.615723} {735.122864 605.249573}} size 47} 48623 {id 48623 center {883.736043 615.755711} corners {{859.388306 639.194397} {905.208618 635.479675} {908.165833 592.238037} {861.758667 595.568054}} size 45}}}

set Hs {{
    {0.16049012153397643 0.025140703661436413 -56.18443035035172}
    {0.03803332982400695 -0.1686580150644637 84.98331034678388}
    {0.00012549119613814434 -9.513034013038792e-5 1}
} {
    {0.1703557060271793 -0.010695915050475279 -54.86197805231042}
    {-0.005782351807719997 -0.18617759205607617 125.39918777541205}
    {5.083591507797107e-6 -9.763536784095669e-5 1}
} {
    {0.15510314590200447 -0.02983454051527247 -57.38376123976827}
    {0.008533999712687673 -0.17796796063024783 88.01267738445614}
    {0.0002807280568875622 -0.0004580039739272952 1}
} {
    {0.09876790983614021 -0.013792250737007372 -8.967749498005295}
    {-0.010801736412439119 -0.12458641332054761 88.94995833626156}
    {-0.0001237806908555834 -0.0002224424659072042 1}
}}

namespace eval Evaluator { source "lib/environment.tcl" }
source "lib/language.tcl"

lappend auto_path "./vendor"
package require math::linearalgebra
rename ::scale scaleTk
namespace import ::math::linearalgebra::*

fn processHomography {H} {
    fn h {i j} { getelem $H [- $j 1] [- $i 1] }

    fn v {i j} {
        list \
            [* [h $i 1] [h $j 1]] \
            [+ [* [h $i 1] [h $j 2]] [* [h $i 2] [h $j 1]]] \
            [* [h $i 2] [h $j 2]] \
            [+ [* [h $i 3] [h $j 1]] [* [h $i 1] [h $j 3]]] \
            [+ [* [h $i 3] [h $j 2]] [* [h $i 2] [h $j 3]]] \
            [* [h $i 3] [h $j 3]]
    }
    # TODO: How do I check v_{ij}?

    set V [list \
               [v 1 2] \
               [sub [v 1 1] [v 2 2]]]
    return $V
}

# Draw detections:
package require Tk
canvas .canv -width 1280 -height 720 -background white
set detectionButtons [lmap {i detection} [lenumerate $detections] {
    button .detection$i -text detection$i -command [list apply {{detection} {
        set ROWS 4
        set COLS 6

        .canv delete all
        .canv create rectangle 4 4 [- 1280 2] [- 720 2] -outline blue
        dict for {id tag} $detection {
            set corners [dict get $tag corners]
            .canv create line {*}[join $corners] {*}[lindex $corners 0]
        }

        fn drawDetectionTagCorner {row col corner label} {
            fn detectionTagCorner {row col corner} {
                set id [expr {48600 + $row*$COLS + $col}]
                return [lindex [dict get [dict get $detection $id] corners] $corner]
            }
            .canv create oval \
                {*}[detectionTagCorner $row $col $corner] \
                {*}[add [detectionTagCorner $row $col $corner] {5 5}] \
                -fill red
            .canv create text [detectionTagCorner $row $col $corner] \
                -text $label
        }

        drawDetectionTagCorner 0 0 3 TL
        drawDetectionTagCorner 0 [- $COLS 1] 2 TR
        drawDetectionTagCorner [- $ROWS 1] [- $COLS 1] 1 BR
        drawDetectionTagCorner [- $ROWS 1] 0 0 BL
    }} $detection]
}]
set homButtons [lmap {i H} [lenumerate $Hs] {
    button .h$i -text H$i -command [list apply {{detection H} {
        .canv delete all
        .canv create rectangle 4 4 [- 1280 2] [- 720 2] -outline red
        dict for {id tag} $detection {
            set corners [lmap corner [dict get $tag corners] {
                set corner [list {*}$corner 1]
                set corner [matmul $H $corner]
                lassign $corner cx cy cz
                list [/ $cx $cz] [/ $cy $cz]
            }]
            .canv create line {*}[join $corners] {*}[lindex $corners 0]
        }
    }} [lindex $detections $i] $H]
}]
pack .canv {*}$detectionButtons {*}$homButtons -fill both -expand true

try {
    # Construct V:
    set Vtop [list]; set Vbottom [list]
    foreach H $Hs {
        lassign [processHomography $H] Vtop_ Vbottom_
        lappend Vtop $Vtop_
        lappend Vbottom $Vbottom_
    }
    set V [list {*}$Vtop {*}$Vbottom]
    assert {[shape $V] eq [list [* 2 [llength $Hs]] 6]}

    # Solve Vb = 0:
    lassign [determineSVD [matmul [transpose $V] $V]] U S V'
    set b [lindex [transpose ${V'}] [lindex [lsort -real -indices $S] 0]]

    # Compute camera intrinsic matrix A:
    lassign $b B11 B12 B22 B13 B23 B33
    set v0 [expr {($B12*$B13 - $B11*$B23) / ($B11*$B22 - $B12*$B12)}]
    set lambda [expr {$B33 - ($B13*$B13 + $v0*($B12*$B13 - $B11*$B23))/$B11}]
    set alpha [expr {sqrt($lambda/$B11)}]
    set beta [expr {sqrt($lambda*$B11/($B11*$B22 - $B12*$B12))}]
    set gamma [expr {-$B12*$alpha*$alpha*$beta/$lambda}]
    set u0 [expr {$gamma*$v0/$beta - $B13*$alpha*$alpha/$lambda}]

    foreach var {v0 lambda alpha beta gamma u0} {
        puts "$var = [set $var]"
    }
} on error e {
    puts stderr $::errorInfo
}

vwait forever
