set detections {{48600 {id 48600 center {583.158965 383.664246} corners {{621.965210 355.769196} {559.476624 350.512390} {544.083008 411.753174} {608.062439 418.525513}} size 62} 48601 {id 48601 center {465.963150 372.745183} corners {{503.665955 346.214508} {445.730774 341.224213} {428.066284 399.412415} {487.186005 405.809265}} size 58} 48602 {id 48602 center {357.701760 362.538066} corners {{394.051331 337.100342} {340.535126 332.725525} {321.165924 388.106140} {375.802490 393.972809}} size 53} 48603 {id 48603 center {257.742203 353.240199} corners {{292.700836 328.920746} {243.394287 324.812378} {222.686432 377.627228} {272.803375 383.081207}} size 49} 48604 {id 48604 center {165.595052 344.589451} corners {{199.128540 321.201416} {153.718018 317.504761} {132.169083 367.902496} {178.063599 373.023041}} size 45} 48605 {id 48605 center {80.862069 336.524193} corners {{113.160408 314.036896} {71.082787 310.547791} {48.756218 358.877472} {91.024925 363.519470}} size 42} 48606 {id 48606 center {610.249623 269.473638} corners {{646.846252 243.206955} {587.440796 240.704315} {573.437500 295.894989} {634.448364 299.996094}} size 59} 48607 {id 48607 center {497.564440 263.500873} corners {{533.041016 238.460815} {477.770172 236.023315} {461.719147 288.801178} {518.382751 292.399963}} size 55} 48608 {id 48608 center {393.109677 257.957114} corners {{427.552582 233.953278} {376.061890 231.563263} {358.399017 282.147552} {410.934692 285.554291}} size 51} 48609 {id 48609 center {296.114660 252.862911} corners {{329.464172 229.716232} {281.713318 227.598434} {262.649078 276.090149} {311.111786 279.172577}} size 47} 48610 {id 48610 center {206.335115 248.065676} corners {{238.602188 225.741867} {194.186356 223.827255} {174.054306 270.398987} {218.963623 273.261261}} size 44} 48611 {id 48611 center {123.256807 243.679741} corners {{154.293625 222.160950} {113.236687 220.460144} {92.129250 265.261444} {133.692062 267.861328}} size 41} 48612 {id 48612 center {634.987933 165.965494} corners {{669.679932 140.939178} {612.952576 140.541519} {599.985046 191.216080} {658.163696 192.705246}} size 56} 48613 {id 48613 center {526.207244 164.116731} corners {{559.963196 140.106323} {506.920837 139.680695} {492.241516 188.276352} {546.515137 189.847000}} size 53} 48614 {id 48614 center {425.292930 162.381134} corners {{458.124207 139.399673} {408.630707 138.992645} {392.190826 185.552170} {442.795349 186.948990}} size 49} 48615 {id 48615 center {331.386499 160.841882} corners {{363.187897 138.636230} {316.974518 138.236237} {299.455322 183.138153} {346.355682 184.321518}} size 46} 48616 {id 48616 center {244.037601 159.379355} corners {{274.933868 138.103897} {231.807465 137.657608} {212.892975 180.825836} {256.721100 181.906311}} size 43} 48617 {id 48617 center {162.785382 158.227115} corners {{192.659180 137.646347} {152.470474 137.252075} {132.897995 178.817245} {173.438477 179.889847}} size 40} 48618 {id 48618 center {657.473615 71.493364} corners {{690.413269 47.438381} {636.045776 48.808983} {624.244141 95.759995} {679.958801 95.297096}} size 54} 48619 {id 48619 center {552.499698 73.174196} corners {{584.639404 50.008228} {533.659424 51.453991} {520.173340 96.474701} {572.235657 95.927002}} size 51} 48620 {id 48620 center {454.820340 74.811843} corners {{486.327942 52.438698} {438.474579 53.875065} {423.390900 97.129486} {472.014069 96.834755}} size 47} 48621 {id 48621 center {363.761416 76.273481} corners {{394.456177 54.835030} {349.615723 56.068108} {333.244690 97.587585} {378.568878 97.424110}} size 44} 48622 {id 48622 center {278.849153 77.705692} corners {{308.562134 57.175156} {266.713928 58.149891} {249.104935 98.257812} {291.504852 98.100235}} size 41} 48623 {id 48623 center {199.516596 79.242200} corners {{228.455215 59.270126} {189.006912 60.363037} {170.655396 99.160843} {210.369354 98.737648}} size 39}} {48600 {id 48600 center {697.699075 371.965302} corners {{720.771973 353.366943} {669.508545 349.478821} {673.662231 391.340668} {726.993103 395.332001}} size 51} 48601 {id 48601 center {593.092987 363.965788} corners {{618.894531 345.208038} {565.786682 341.140900} {565.958740 383.692413} {621.501404 387.711914}} size 53} 48602 {id 48602 center {484.484365 355.750504} corners {{513.304626 336.933960} {457.657257 332.467102} {454.048981 375.621552} {512.143799 379.756287}} size 55} 48603 {id 48603 center {371.224567 347.291140} corners {{403.440063 328.288452} {345.268158 323.612671} {337.249146 367.331940} {397.872253 371.600220}} size 58} 48604 {id 48604 center {252.898865 338.261730} corners {{288.323059 319.094696} {228.531433 314.376740} {215.780731 358.345306} {278.206055 363.067871}} size 59} 48605 {id 48605 center {130.817432 328.946480} corners {{169.449921 309.666901} {107.888824 304.710052} {90.461731 349.086029} {154.440628 353.917114}} size 61} 48606 {id 48606 center {687.978329 295.001411} corners {{709.473389 279.264099} {661.671509 274.935394} {665.595276 311.388855} {715.001892 315.614136}} size 47} 48607 {id 48607 center {590.135392 286.188191} corners {{614.103638 270.410980} {564.731750 265.983337} {565.187500 302.610260} {616.436340 307.106720}} size 49} 48608 {id 48608 center {488.713703 277.097644} corners {{515.415283 261.202789} {463.960785 256.652161} {460.843933 293.687897} {514.317871 298.246246}} size 51} 48609 {id 48609 center {383.425162 267.667876} corners {{413.029572 251.796402} {359.216827 246.870682} {352.497711 284.248657} {408.290375 289.029388}} size 54} 48610 {id 48610 center {273.813356 257.790031} corners {{306.172455 241.827988} {250.894058 236.815720} {240.037689 274.450836} {297.501648 279.468079}} size 55} 48611 {id 48611 center {160.763331 247.634768} corners {{195.937561 231.628403} {139.083008 226.437927} {123.949661 264.387177} {183.035553 269.410309}} size 57} 48612 {id 48612 center {679.470641 227.530823} corners {{699.752380 214.141769} {654.903076 209.407013} {658.359985 241.467087} {704.491638 245.989136}} size 45} 48613 {id 48613 center {587.611740 218.143847} corners {{609.936951 204.682205} {563.950378 199.982849} {564.249512 232.230789} {612.030212 236.885956}} size 46} 48614 {id 48614 center {492.482431 208.519662} corners {{517.250671 195.108917} {469.328369 190.160080} {466.633972 222.515289} {516.497620 227.562057}} size 48} 48615 {id 48615 center {394.013342 198.460754} corners {{421.223145 185.080978} {371.465454 179.944809} {365.609528 212.427658} {417.359100 217.631897}} size 50} 48616 {id 48616 center {291.879971 188.104920} corners {{321.888184 174.624466} {270.357239 169.390610} {261.021332 201.967407} {314.047333 207.379745}} size 51} 48617 {id 48617 center {186.818130 177.398836} corners {{219.101990 163.914597} {166.290665 158.610504} {153.234344 191.426025} {207.982315 196.769943}} size 53} 48618 {id 48618 center {671.795445 167.853419} corners {{691.009766 156.230911} {648.840576 151.556778} {651.857178 179.913834} {695.403931 184.614090}} size 42} 48619 {id 48619 center {585.262256 158.287249} corners {{606.403320 146.747559} {562.820740 141.694122} {563.338501 170.254166} {608.052612 175.138306}} size 43} 48620 {id 48620 center {495.718539 148.251141} corners {{518.963501 136.758301} {474.026886 131.679092} {471.716431 160.118332} {518.094666 165.346115}} size 45} 48621 {id 48621 center {403.356407 137.819765} corners {{428.698273 126.430969} {382.276611 121.137459} {376.933990 149.694168} {425.064575 154.999359}} size 46} 48622 {id 48622 center {307.909435 127.068080} corners {{335.379395 115.699478} {287.606750 110.290131} {279.175629 138.959732} {328.829468 144.356201}} size 48} 48623 {id 48623 center {209.693760 116.119123} corners {{239.424530 104.748444} {190.308563 99.250267} {178.634750 127.997795} {229.667374 133.500015}} size 49}} {48600 {id 48600 center {519.687222 358.097912} corners {{551.229004 339.554535} {502.190399 329.569122} {487.672272 376.919464} {537.727783 387.513275}} size 50} 48601 {id 48601 center {424.201417 338.303571} corners {{455.777527 320.213379} {408.005585 310.459351} {392.310699 356.574005} {440.855011 366.934784}} size 48} 48602 {id 48602 center {331.371072 319.085539} corners {{362.826599 301.328735} {316.516785 291.914093} {299.786224 336.915344} {346.576233 346.898804}} size 47} 48603 {id 48603 center {241.263530 300.372482} corners {{272.488129 282.931305} {227.940933 273.953003} {210.069199 317.796753} {254.884338 327.383331}} size 45} 48604 {id 48604 center {154.425714 282.169831} corners {{185.123001 265.110809} {142.335724 256.492126} {123.669121 299.261810} {166.857681 308.573853}} size 43} 48605 {id 48605 center {71.119847 264.692601} corners {{101.360077 247.993118} {60.208286 239.605316} {40.793343 281.439728} {82.267273 290.322174}} size 41} 48606 {id 48606 center {546.245555 267.784999} corners {{576.398132 250.368591} {529.081848 241.206512} {515.594788 285.489166} {563.913208 295.143860}} size 48} 48607 {id 48607 center {453.302795 249.835525} corners {{483.612610 232.695358} {437.350037 224.007355} {422.747894 267.114288} {469.729950 276.431763}} size 47} 48608 {id 48608 center {362.916173 232.323990} corners {{393.125458 215.538025} {348.242828 207.146149} {332.568237 249.186996} {378.058960 258.307343}} size 45} 48609 {id 48609 center {275.152509 215.318693} corners {{305.051178 198.926697} {261.794708 190.807877} {245.054001 231.820251} {288.891968 240.529831}} size 44} 48610 {id 48610 center {190.310309 199.010258} corners {{219.985779 182.864685} {178.204391 175.062317} {160.414780 215.275558} {202.698135 223.515869}} size 42} 48611 {id 48611 center {108.655194 183.260771} corners {{137.943619 167.427429} {97.657143 159.890701} {79.109344 199.233276} {119.875694 207.103531}} size 40} 48612 {id 48612 center {570.979042 183.060716} corners {{600.101196 166.349701} {554.215942 158.423416} {541.630920 199.901398} {588.258728 208.457260}} size 46} 48613 {id 48613 center {480.549143 166.756274} corners {{509.668945 150.519836} {464.971741 142.655594} {451.303955 183.062622} {496.640564 191.652222}} size 45} 48614 {id 48614 center {392.663480 150.910200} corners {{421.614258 135.029877} {378.144073 127.348274} {363.339935 166.994995} {407.461029 174.923492}} size 44} 48615 {id 48615 center {307.099494 135.510840} corners {{335.953308 119.918785} {293.834351 112.596558} {278.032074 151.218323} {320.702850 159.009354}} size 42} 48616 {id 48616 center {224.270020 120.756833} corners {{252.969543 105.459122} {212.162689 98.379517} {195.374481 136.159027} {236.661362 143.659073}} size 41} 48617 {id 48617 center {144.290576 106.637637} corners {{172.794739 91.557938} {133.325821 84.872940} {115.682777 121.772163} {155.575775 129.038406}} size 40} 48618 {id 48618 center {594.325949 103.184354} corners {{622.404724 87.300278} {577.915649 80.174919} {566.091675 119.156395} {611.205688 126.852005}} size 45} 48619 {id 48619 center {506.291599 88.495521} corners {{534.266052 73.072952} {490.965973 65.967590} {478.112152 104.031105} {522.009888 111.600647}} size 43} 48620 {id 48620 center {420.561390 74.142968} corners {{448.463654 59.046700} {406.346924 52.256256} {392.369080 89.396164} {435.206024 96.692032}} size 42} 48621 {id 48621 center {337.286787 60.345013} corners {{365.107666 45.503452} {324.130524 38.915466} {309.190369 75.333565} {350.759247 82.289597}} size 41} 48622 {id 48622 center {256.369619 47.143116} corners {{284.324097 32.501076} {244.339661 26.209299} {228.468277 61.757324} {268.648163 68.509506}} size 40} 48623 {id 48623 center {178.232313 34.505744} corners {{205.816284 20.096773} {167.088333 13.999072} {150.596771 48.941654} {189.517883 55.272964}} size 39}} {48600 {id 48600 center {721.628009 365.785851} corners {{741.793907 349.227384} {701.1549299999999 345.71415299999995} {701.013511 382.712669} {742.552841 386.30044499999997}} size 40} 48601 {id 48601 center {639.846061 357.956938} corners {{661.028412 341.541834} {620.0496899999999 337.842892} {618.09848 374.810063} {660.045937 378.48096499999997}} size 41} 48602 {id 48602 center {556.6277709999999 350.933803} corners {{578.953339 334.561065} {537.462746 330.757076} {533.667519 367.771995} {576.129959 371.465492}} size 41} 48603 {id 48603 center {472.849116 343.130285} corners {{496.589615 326.839701} {454.267448 322.847849} {448.547905 359.805626} {491.705734 363.71283700000004}} size 42} 48604 {id 48604 center {387.215413 335.216688} corners {{412.208824 318.966494} {369.214901 315.018557} {361.647087 351.84067899999997} {405.633293 355.88314099999997}} size 43} 48605 {id 48605 center {300.95679400000006 328.275885} corners {{327.417823 312.17009} {283.484932 308.02644000000004} {273.85521700000004 344.77155700000003} {318.887916 349.05760200000003}} size 44} 48606 {id 48606 center {721.3504109999999 296.760935} corners {{740.561463 281.873256} {701.951424 278.23998600000004} {701.7405319999999 311.957687} {741.091744 315.608734}} size 38} 48607 {id 48607 center {642.48658 288.640001} corners {{662.749687 273.791954} {623.666252 270.113085} {621.755287 303.831116} {661.721047 307.5746}} size 39} 48608 {id 48608 center {563.43412 281.339855} corners {{584.781677 266.53168900000003} {545.134964 262.7486} {541.548923 296.520966} {582.137863 300.342156}} size 39} 48609 {id 48609 center {482.58990500000004 273.33153400000003} corners {{505.066559 258.590919} {464.66940700000004 254.627502} {459.523522 288.458904} {500.80474100000004 292.342773}} size 40} 48610 {id 48610 center {400.959917 266.17380099999997} corners {{424.730584 251.43237299999998} {383.601242 247.52612699999997} {376.65514 281.24645999999996} {418.78299 285.320358}} size 41} 48611 {id 48611 center {318.95324899999997 258.022913} corners {{344.10232499999995 243.44368699999998} {301.9785 239.27656} {293.178833 272.964657} {336.280807 277.158897}} size 42} 48612 {id 48612 center {720.912689 232.28083999999998} corners {{739.4314810000001 218.850159} {702.363739 215.101643} {701.8238150000001 246.12497} {739.774483 249.749779}} size 37} 48613 {id 48613 center {645.705292 225.03850799999998} corners {{665.14418 211.569092} {627.576016 207.838753} {625.707455 238.89522599999998} {664.1637119999999 242.55052999999998}} size 37} 48614 {id 48614 center {568.754399 217.56884} corners {{589.230575 204.151691} {551.119499 200.283157} {547.768531 231.319969} {586.713226 235.172035}} size 38} 48615 {id 48615 center {491.67896 209.351076} corners {{513.225677 196.02556199999998} {474.559502 191.996488} {469.517937 223.056507} {509.1259 227.037643}} size 38} 48616 {id 48616 center {413.817931 201.934936} corners {{436.556069 188.663052} {396.943249 184.459923} {390.45608899999996 215.57086600000002} {430.83939399999997 219.56195100000002}} size 39} 48617 {id 48617 center {334.260337 193.437897} corners {{358.411331 180.147188} {317.87476 175.934307} {309.693035 206.957707} {351.010071 211.33049}} size 40} 48618 {id 48618 center {721.132122 172.581957} corners {{739.253174 160.225964} {703.007072 156.41867100000002} {702.818706 185.069115} {739.408409 188.880112}} size 36} 48619 {id 48619 center {648.812648 165.18617} corners {{667.6647039999999 152.88768800000003} {631.334267 149.00967400000002} {629.576592 177.735161} {666.456009 181.515358}} size 36} 48620 {id 48620 center {575.133831 157.78149100000002} corners {{595.073113 145.392506} {558.0769660000001 141.660695} {555.028691 170.273529} {592.477303 174.17316499999998}} size 37} 48621 {id 48621 center {500.978341 150.11118} corners {{521.870445 137.763203} {484.256668 133.939682} {479.73133800000005 162.668915} {517.97036 166.544128}} size 37} 48622 {id 48622 center {425.352576 142.402586} corners {{447.257416 130.30683900000002} {408.884457 126.055226} {402.99877499999997 154.746247} {441.932701 158.86113}} size 38} 48623 {id 48623 center {349.18162900000004 133.565257} corners {{372.31707000000006 121.49641} {333.045567 117.238855} {325.742718 145.792412} {365.53107500000004 150.107559}} size 39}}}

set Hs {{
    {-0.0003304055581132268 -7.332286571240487e-5 0.2315946995123993}
    {3.735964199372129e-5 -0.00035031293284923035 0.12389790490038968}
    {0.0005039911575165035 0.0008056173504497547 1}
} {
    {-0.00030728383357380947 4.6244447225808415e-5 0.2051113178146416}
    {2.8490083698996335e-5 -0.0003921386291830342 0.13431285459126285}
    {-0.0002885577800808062 0.0010586389880762087 1}
} {
    {-0.0003099587851968029 -8.742580111060728e-5 0.20055210889312014}
    {7.131541695229981e-5 -0.0003340991961601663 0.09111959262741268}
    {0.00010844570527965585 0.0004605713759024384 1}
} {
    {-0.00036522945594072887 5.330701536347087e-6 0.2691429177500194}
    {3.758964975735577e-5 -0.00042423913513563996 0.13597146546979333}
    {-0.0001458268921712936 0.0006588804357837561 1}
}}


namespace eval Evaluator { source "lib/environment.tcl" }
source "lib/language.tcl"

lappend auto_path "./vendor"
package require math::linearalgebra
rename ::scale scaleTk
namespace import ::math::linearalgebra::*

fn processHomography {H} {
    fn h {i j} { getelem $H [- $j 1] [- $i 1] }

    fn v {i j} {
        list \
            [* [h $i 1] [h $j 1]] \
            [+ [* [h $i 1] [h $j 2]] [* [h $i 2] [h $j 1]]] \
            [* [h $i 2] [h $j 2]] \
            [+ [* [h $i 3] [h $j 1]] [* [h $i 1] [h $j 3]]] \
            [+ [* [h $i 3] [h $j 2]] [* [h $i 2] [h $j 3]]] \
            [* [h $i 3] [h $j 3]]
    }
    # TODO: How do I check v_{ij}?

    set V [list \
               [v 1 2] \
               [sub [v 1 1] [v 2 2]]]
    return $V
}

# Draw detections:
package require Tk
canvas .canv -width 1280 -height 720 -background white
set detectionButtons [lmap {i detection} [lenumerate $detections] {
    button .detection$i -text detection$i -command [list apply {{detection} {
        set ROWS 4
        set COLS 6

        .canv delete all
        .canv create rectangle 4 4 [- 1280 2] [- 720 2] -outline blue
        dict for {id tag} $detection {
            set corners [dict get $tag corners]
            .canv create line {*}[join $corners] {*}[lindex $corners 0]
        }

        fn drawDetectionTagCorner {row col corner label} {
            fn detectionTagCorner {row col corner} {
                set id [expr {48600 + $row*$COLS + $col}]
                return [lindex [dict get [dict get $detection $id] corners] $corner]
            }
            .canv create oval \
                {*}[detectionTagCorner $row $col $corner] \
                {*}[add [detectionTagCorner $row $col $corner] {5 5}] \
                -fill red
            .canv create text [detectionTagCorner $row $col $corner] \
                -text $label
        }

        drawDetectionTagCorner 0 0 3 TL
        drawDetectionTagCorner 0 [- $COLS 1] 2 TR
        drawDetectionTagCorner [- $ROWS 1] [- $COLS 1] 1 BR
        drawDetectionTagCorner [- $ROWS 1] 0 0 BL
    }} $detection]
}]
set homButtons [lmap {i H} [lenumerate $Hs] {
    button .h$i -text H$i -command [list apply {{detection H} {
        .canv delete all
        .canv create rectangle 4 4 [- 1280 2] [- 720 2] -outline red
        dict for {id tag} $detection {
            set corners [lmap corner [dict get $tag corners] {
                set corner [list {*}$corner 1]
                set corner [matmul $H $corner]
                lassign $corner cx cy cz
                list [* [/ $cx $cz] 1000] [* [/ $cy $cz] 1000]
            }]
            .canv create line {*}[join $corners] {*}[lindex $corners 0]
        }
    }} [lindex $detections $i] $H]
}]
pack .canv {*}$detectionButtons {*}$homButtons -fill both -expand true

try {
    # Construct V:
    set Vtop [list]; set Vbottom [list]
    foreach H $Hs {
        lassign [processHomography $H] Vtop_ Vbottom_
        lappend Vtop $Vtop_
        lappend Vbottom $Vbottom_
    }
    set V [list {*}$Vtop {*}$Vbottom]
    assert {[shape $V] eq [list [* 2 [llength $Hs]] 6]}

    # Solve Vb = 0:
    lassign [determineSVD [matmul [transpose $V] $V]] U S V'
    set b [lindex [transpose ${V'}] [lindex [lsort -real -indices $S] 0]]

    # Compute camera intrinsic matrix A:
    lassign $b B11 B12 B22 B13 B23 B33
    puts $b
    set v0 [expr {($B12*$B13 - $B11*$B23) / ($B11*$B22 - $B12*$B12)}]
    set lambda [expr {$B33 - ($B13*$B13 + $v0*($B12*$B13 - $B11*$B23))/$B11}]
    set alpha [expr {sqrt($lambda/$B11)}]
    set beta [expr {sqrt($lambda*$B11/($B11*$B22 - $B12*$B12))}]
    set gamma [expr {-$B12*$alpha*$alpha*$beta/$lambda}]
    set u0 [expr {$gamma*$v0/$beta - $B13*$alpha*$alpha/$lambda}]

    foreach var {v0 lambda alpha beta gamma u0} {
        puts "$var = [set $var]"
    }
} on error e {
    puts stderr $::errorInfo
}

vwait forever
