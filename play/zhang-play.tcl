set detections {{48600 {id 48600 center {550.009149 516.419016} corners {{575.604370 491.172821} {530.604187 492.061096} {524.406677 541.672363} {570.399902 542.014343}} size 45} 48601 {id 48601 center {437.495060 517.100463} corners {{461.982544 493.132751} {420.835815 494.057617} {413.077728 540.999512} {454.879303 541.146118}} size 41} 48602 {id 48602 center {335.345465 517.684419} corners {{358.649445 494.932556} {321.179413 495.783875} {312.213470 540.268372} {350.078522 540.461548}} size 37} 48603 {id 48603 center {242.583532 518.064562} corners {{264.506470 496.620728} {230.556122 497.195984} {220.719971 539.450317} {255.043320 539.683350}} size 33} 48604 {id 48604 center {158.238038 518.069145} corners {{178.947281 497.661957} {148.070175 498.305420} {137.532898 538.472290} {168.818359 538.634583}} size 30} 48605 {id 48605 center {81.597336 517.938207} corners {{101.153107 498.607025} {73.127586 498.981720} {62.089211 537.222290} {90.358643 537.547241}} size 28} 48606 {id 48606 center {564.019022 392.995422} corners {{588.246399 369.407928} {545.391785 372.291351} {539.878723 416.498138} {583.456360 414.599915}} size 42} 48607 {id 48607 center {456.160354 399.157937} corners {{479.312653 376.763336} {440.128632 379.371918} {432.938538 421.619781} {472.805145 419.700592}} size 39} 48608 {id 48608 center {357.594709 404.898196} corners {{379.856781 383.410889} {343.897247 385.986053} {335.482574 426.240784} {371.795471 424.505249}} size 36} 48609 {id 48609 center {267.534839 410.080324} corners {{288.620697 389.622620} {255.862106 391.807526} {246.448166 430.538818} {279.602142 428.970795}} size 32} 48610 {id 48610 center {185.191593 414.742331} corners {{205.346924 395.169617} {175.350021 397.263245} {165.089920 434.262939} {195.428741 432.923981}} size 30} 48611 {id 48611 center {109.948378 418.930651} corners {{128.970428 400.194611} {101.447418 402.135132} {90.975349 437.618408} {118.756424 436.332886}} size 27} 48612 {id 48612 center {576.822886 281.101715} corners {{599.833069 258.610443} {559.022705 263.450775} {553.949890 303.458893} {595.432373 299.555176}} size 41} 48613 {id 48613 center {473.194600 291.893741} corners {{495.175262 270.587982} {457.761810 274.783325} {451.219391 313.194214} {489.256561 309.701721}} size 37} 48614 {id 48614 center {378.285721 301.805926} corners {{399.322906 281.482697} {364.964752 285.290070} {357.088287 322.283966} {392.070343 318.896637}} size 34} 48615 {id 48615 center {290.962198 311.018856} corners {{311.128448 291.453918} {279.493073 294.974945} {270.825226 330.555389} {302.678284 327.408234}} size 31} 48616 {id 48616 center {210.767723 319.364572} corners {{230.010452 300.579407} {201.003998 303.907440} {191.475433 338.198120} {220.824600 335.285797}} size 29} 48617 {id 48617 center {137.136991 327.055223} corners {{155.611160 309.005463} {128.748932 312.190369} {118.602417 345.164001} {145.833420 342.466553}} size 27} 48618 {id 48618 center {588.728000 179.089632} corners {{610.481201 157.720261} {571.537231 163.826797} {566.954346 200.479095} {606.558228 194.920212}} size 39} 48619 {id 48619 center {489.049464 193.842004} corners {{509.990570 173.479630} {474.122192 179.003830} {468.029694 214.280869} {504.502808 209.203110}} size 36} 48620 {id 48620 center {397.396147 207.310357} corners {{417.520966 187.746689} {384.489197 192.899490} {377.129608 227.011795} {410.757599 222.228683}} size 33} 48621 {id 48621 center {312.832260 219.794982} corners {{332.358887 200.965073} {301.637299 205.704956} {293.348419 238.583633} {324.373291 234.320572}} size 31} 48622 {id 48622 center {234.806464 231.294099} corners {{253.455460 213.187531} {225.120331 217.623581} {216.079315 249.476547} {244.719940 245.285477}} size 28} 48623 {id 48623 center {162.759719 242.060544} corners {{180.698380 224.612259} {154.405518 228.766647} {144.894485 259.437408} {171.325409 255.690979}} size 26}}
                {15 {id 15 center {622.077456 149.047831} corners {{632.603394 128.388687} {602.500549 137.116043} {611.607971 169.596176} {641.564453 160.924820}} size 31} 48600 {id 48600 center {476.121694 458.103396} corners {{492.363129 443.508606} {460.908356 442.940918} {459.551422 472.993683} {491.233154 473.164337}} size 31} 48601 {id 48601 center {394.713365 457.023319} corners {{411.829163 442.224731} {379.701172 441.799438} {377.391693 471.999908} {409.978516 472.503723}} size 32} 48602 {id 48602 center {311.896306 456.044061} corners {{329.688171 441.152222} {296.961304 440.843292} {293.859009 471.141327} {327.026398 471.443390}} size 32} 48603 {id 48603 center {227.738886 454.796271} corners {{246.188278 439.988556} {212.889374 439.420166} {209.042892 469.801910} {242.660889 470.247437}} size 33} 48604 {id 48604 center {142.533626 453.433345} corners {{161.618179 438.450684} {127.940720 438.115601} {123.313164 468.522705} {157.350784 468.986481}} size 33} 48605 {id 48605 center {56.893133 452.051684} corners {{76.480392 437.070801} {42.562675 436.398132} {37.128757 467.168030} {71.297035 467.785461}} size 33} 48606 {id 48606 center {479.494746 381.573098} corners {{495.155609 368.071014} {464.837463 367.208923} {463.447510 395.408295} {494.228210 396.011932}} size 30} 48607 {id 48607 center {400.127001 379.895454} corners {{416.705994 366.015869} {385.601044 365.357056} {383.432434 393.871796} {414.782227 394.563232}} size 31} 48608 {id 48608 center {319.537219 378.231693} corners {{336.749054 364.384583} {304.998352 363.466125} {302.107239 392.254303} {334.038788 392.959381}} size 31} 48609 {id 48609 center {237.452124 376.263200} corners {{255.388840 362.348358} {223.300629 361.577240} {219.061172 390.530426} {251.843460 391.198059}} size 32} 48610 {id 48610 center {154.474172 374.498203} corners {{172.981049 360.480011} {140.245758 359.647430} {135.632782 388.769775} {168.730591 389.378204}} size 32} 48611 {id 48611 center {70.781708 372.553271} corners {{89.789581 358.384521} {56.862610 357.628326} {51.523655 386.908508} {84.736862 387.516876}} size 32} 48612 {id 48612 center {482.472407 308.942445} corners {{497.784241 296.005402} {468.347839 295.142059} {466.968384 322.041870} {496.715820 322.858948}} size 29} 48613 {id 48613 center {405.258183 306.675086} corners {{421.204346 293.667542} {391.224915 292.807800} {389.193329 319.779449} {419.480103 320.728790}} size 29} 48614 {id 48614 center {326.641601 304.336151} corners {{343.276520 291.265686} {312.615906 290.308899} {309.786224 317.579834} {340.663696 318.359802}} size 30} 48615 {id 48615 center {246.712420 301.790578} corners {{263.859039 288.778168} {232.770554 287.745789} {229.203934 315.077606} {260.833405 316.015808}} size 31} 48616 {id 48616 center {165.712637 299.464414} corners {{183.828278 286.156097} {152.120682 285.396057} {147.598984 312.771271} {179.609375 313.848236}} size 31} 48617 {id 48617 center {84.237047 297.077271} corners {{102.843788 283.550415} {70.788132 282.950439} {65.618469 310.612732} {97.901276 311.430267}} size 32} 48618 {id 48618 center {485.333621 239.757278} corners {{500.019348 227.540909} {471.716003 226.454468} {470.473907 252.118378} {499.087524 253.193222}} size 28} 48619 {id 48619 center {410.056436 236.966258} corners {{425.397034 224.775726} {396.411926 223.602875} {394.439301 249.376541} {423.824768 250.450912}} size 29} 48620 {id 48620 center {333.403948 234.042368} corners {{349.437714 221.814850} {319.785034 220.628326} {317.154236 246.434570} {347.098907 247.531311}} size 29} 48621 {id 48621 center {255.475206 231.153666} corners {{272.238251 218.711349} {242.093796 217.697266} {238.549988 243.716354} {269.101562 244.856384}} size 30} 48622 {id 48622 center {176.659007 228.314354} corners {{194.005508 215.704285} {163.341370 214.668839} {159.281021 240.947311} {190.069138 242.054642}} size 30} 48623 {id 48623 center {97.388292 225.381198} corners {{115.054573 212.973206} {84.480507 211.777222} {79.226990 238.136871} {110.617958 239.324417}} size 30}}
                {15 {id 15 center {621.941166 149.044912} corners {{632.451904 128.280487} {602.581543 137.244217} {611.536621 169.599548} {641.614685 161.036942}} size 31} 48600 {id 48600 center {453.175198 432.561304} corners {{474.552734 417.877411} {437.923431 408.974030} {432.223541 446.952667} {468.519501 456.291687}} size 37} 48601 {id 48601 center {359.635507 408.959275} corners {{379.888275 394.473175} {344.702179 385.926483} {339.904205 423.072388} {374.661987 432.135742}} size 36} 48602 {id 48602 center {270.431337 386.305373} corners {{289.236847 372.108490} {255.734879 363.594635} {251.634476 400.495728} {285.010254 408.834473}} size 34} 48603 {id 48603 center {185.095329 364.538334} corners {{202.847885 350.486877} {170.795288 342.645386} {167.539688 378.433929} {199.542694 386.656830}} size 32} 48604 {id 48604 center {104.163826 343.864143} corners {{120.846321 329.880981} {90.229729 322.412231} {87.756271 357.616852} {118.081917 365.291412}} size 31} 48605 {id 48605 center {27.552639 323.983266} corners {{43.127602 310.318359} {14.202516 303.171570} {12.207083 337.446899} {40.996899 344.941711}} size 29} 48606 {id 48606 center {468.414545 331.611442} corners {{490.289886 315.992615} {452.690887 307.547516} {446.905823 346.968506} {484.100525 355.617706}} size 38} 48607 {id 48607 center {372.633590 309.737427} corners {{393.255798 294.352203} {357.292236 286.347168} {352.363373 324.860046} {387.948181 333.086884}} size 36} 48608 {id 48608 center {281.114647 288.767986} corners {{300.605072 273.581207} {266.235657 266.048645} {261.983948 303.674469} {296.089996 311.634460}} size 35} 48609 {id 48609 center {194.007877 268.803823} corners {{212.165771 253.816666} {179.484665 246.530991} {175.988297 283.676819} {208.490280 291.014069}} size 33} 48610 {id 48610 center {111.289898 249.843305} corners {{128.336121 234.953415} {97.319557 228.292877} {94.517944 264.493622} {125.353996 271.538361}} size 31} 48611 {id 48611 center {33.176532 231.934072} corners {{49.029900 217.374252} {19.771063 210.824966} {17.585236 246.253204} {46.556587 253.003159}} size 29} 48612 {id 48612 center {484.193286 226.254878} corners {{506.576843 209.492783} {468.165710 201.915024} {462.181702 242.738419} {500.309631 250.729538}} size 39} 48613 {id 48613 center {386.140040 206.314705} corners {{407.225769 189.852402} {370.495880 182.514359} {365.387756 222.516678} {401.779205 230.107452}} size 37} 48614 {id 48614 center {292.536175 187.256347} corners {{312.350372 170.966919} {277.352966 164.214066} {273.092743 203.240967} {307.794189 210.412155}} size 35} 48615 {id 48615 center {203.584245 169.216888} corners {{222.146194 153.260437} {188.987808 146.834885} {185.191757 185.027664} {218.304932 191.789413}} size 33} 48616 {id 48616 center {119.333838 152.363315} corners {{136.780045 136.510345} {105.351265 130.596878} {102.183922 167.947052} {133.410339 174.275970}} size 31} 48617 {id 48617 center {39.803309 136.538615} corners {{56.069740 121.029320} {26.404640 115.417488} {23.749165 151.845505} {53.266224 157.761017}} size 30} 48618 {id 48618 center {500.772542 116.219788} corners {{523.725037 98.150894} {484.556366 91.552643} {478.185822 134.000732} {517.133667 141.107422}} size 39} 48619 {id 48619 center {400.403607 98.443856} corners {{421.939850 80.761208} {384.647186 74.443298} {379.141174 115.901688} {416.271881 122.614792}} size 37} 48620 {id 48620 center {304.850743 81.709940} corners {{325.042206 64.300209} {289.422455 58.320648} {285.010498 98.816841} {320.272003 105.088577}} size 36} 48621 {id 48621 center {214.108412 66.015748} corners {{233.176056 48.970718} {199.381927 43.359325} {195.347763 82.786346} {228.879044 88.740089}} size 34} 48622 {id 48622 center {128.296202 51.468317} corners {{146.077103 34.665268} {114.299789 29.701071} {110.782318 68.019035} {142.440460 73.465492}} size 32} 48623 {id 48623 center {47.406240 38.028919} corners {{64.075310 21.657188} {33.951202 16.870775} {30.893682 54.246929} {60.969002 59.356461}} size 30}}
    {15 {id 15 center {621.985501 149.080967} corners {{632.587952 128.295517} {602.551086 137.136871} {611.529297 169.579712} {641.599060 161.135162}} size 31} 48600 {id 48600 center {540.802013 339.639413} corners {{555.257507 318.889404} {524.965576 324.222534} {526.406738 360.302979} {557.257996 355.659424}} size 30} 48601 {id 48601 center {463.637619 352.158329} corners {{476.797668 332.576019} {449.254211 337.274353} {450.461517 371.764526} {478.512756 367.551147}} size 27} 48602 {id 48602 center {393.270181 363.663744} corners {{405.469116 344.935974} {380.247681 349.310699} {381.187439 382.213135} {406.654236 378.415283}} size 25} 48603 {id 48603 center {328.920200 374.025566} corners {{340.299042 356.245636} {317.158173 360.198364} {317.558807 391.778229} {341.097412 388.340851}} size 23} 48604 {id 48604 center {269.829147 383.636400} corners {{280.352203 366.622131} {259.059601 370.277008} {259.306244 400.650421} {280.832428 397.285736}} size 21} 48605 {id 48605 center {215.756149 392.334479} corners {{225.538620 376.083435} {206.033234 379.508301} {205.937881 408.644989} {225.852158 405.652832}} size 19} 48606 {id 48606 center {536.033499 244.063619} corners {{550.153137 222.923416} {520.359863 229.855469} {522.067932 264.973145} {552.095520 258.623840}} size 30} 48607 {id 48607 center {459.973738 260.873052} corners {{473.038971 240.823273} {445.811279 247.166153} {447.131439 280.580719} {474.575439 275.005066}} size 27} 48608 {id 48608 center {390.649354 276.165330} corners {{402.741302 257.107574} {377.951294 262.887695} {378.702667 294.994141} {403.679047 289.789734}} size 25} 48609 {id 48609 center {327.255584 290.126547} corners {{338.556305 271.902771} {315.680573 277.302856} {316.071991 308.161438} {339.157776 303.312714}} size 23} 48610 {id 48610 center {268.996788 303.220437} corners {{279.711151 285.462036} {258.382355 290.828949} {258.747589 320.207855} {279.779999 315.808960}} size 21} 48611 {id 48611 center {215.508193 314.817298} corners {{225.094757 298.379364} {205.990250 302.646362} {205.889404 331.310486} {225.243301 327.265930}} size 19} 48612 {id 48612 center {531.327529 151.115408} corners {{545.388489 129.514572} {515.959656 138.137131} {517.667786 172.099884} {547.095581 164.431641}} size 30} 48613 {id 48613 center {456.553153 171.826966} corners {{469.375397 151.552902} {442.736328 159.250610} {443.819733 191.960587} {470.831787 184.823669}} size 27} 48614 {id 48614 center {388.366088 190.897177} corners {{400.285858 171.565506} {375.784882 178.631088} {376.564392 210.037354} {401.139679 203.350830}} size 25} 48615 {id 48615 center {325.866878 208.290064} corners {{336.843079 189.934265} {314.473999 196.391006} {314.958893 226.531784} {337.519135 220.460022}} size 23} 48616 {id 48616 center {268.382058 224.313300} corners {{278.825562 206.726334} {258.073700 212.738281} {258.053772 241.706238} {279.016418 236.254379}} size 21} 48617 {id 48617 center {215.505701 239.153518} corners {{225.011200 222.430573} {206.092514 227.805649} {206.068710 255.755936} {225.078979 250.694382}} size 19} 48618 {id 48618 center {527.097997 60.487003} corners {{540.825745 38.779671} {512.003052 48.730518} {513.503357 81.983856} {542.567261 72.535019}} size 30} 48619 {id 48619 center {453.516362 85.339189} corners {{466.268555 64.567642} {439.916016 73.876572} {441.057434 105.633049} {467.426544 97.062943}} size 27} 48620 {id 48620 center {386.366651 107.854436} corners {{398.102814 88.282501} {374.115143 96.658226} {374.676605 127.349464} {398.948608 119.352631}} size 25} 48621 {id 48621 center {324.775756 128.544412} corners {{335.671875 109.881294} {313.638519 117.579758} {314.015320 146.975128} {336.235291 139.826370}} size 23} 48622 {id 48622 center {268.201233 147.556623} corners {{278.402069 129.779327} {257.939117 136.792267} {257.902191 165.505066} {278.470337 158.328308}} size 21} 48623 {id 48623 center {215.797031 165.266603} corners {{225.433487 148.129639} {206.545715 154.709869} {206.304306 182.147964} {225.316223 176.129013}} size 20}}
}



set Hs {{
    {-0.3519666705427916 -0.03670959824996767 220.6588831621248}
    {0.06324316028212969 0.40598359951413654 -102.6405997211591}
    {0.000830646407105137 0.0008205081836878169 1}
} {
    {-0.30765319305716415 -0.011005060310939438 156.33665042931233}
    {-0.013744467663103811 0.3623111879148667 -75.56811727950632}
    {-0.00011678317586260406 0.0003619857280887585 1}
} {
    {-0.24086096122394413 -0.037127461394332296 129.7890093566699}
    {-0.039014694676006594 0.2350928722535683 -2.641603171980269}
    {0.0003171984745828326 -0.00015173733740833105 1}
} {
    {-0.4386062920908817 0.02274455408899765 236.32754835712566}
    {0.1415122468820683 0.4080448317107608 -92.35731067361216}
    {0.0010299214686944186 0.00020075217911315254 1}
}}

namespace eval Evaluator { source "lib/environment.tcl" }
source "lib/language.tcl"

lappend auto_path "./vendor"
package require math::linearalgebra
namespace import ::math::linearalgebra::eigenvectorsSVD \
    ::math::linearalgebra::sub \
    ::math::linearalgebra::mkMatrix \
    ::math::linearalgebra::getelem \
    ::math::linearalgebra::matmul \
    ::math::linearalgebra::transpose \
    ::math::linearalgebra::shape

fn processHomography {H} {
    fn h {i j} { getelem $H [- $j 1] [- $i 1] }

    fn v {i j} {
        list \
            [* [h $i 1] [h $j 1]] \
            [+ [* [h $i 1] [h $j 2]] [* [h $i 2] [h $j 1]]] \
            [* [h $i 2] [h $j 2]] \
            [+ [* [h $i 3] [h $j 1]] [* [h $i 1] [h $j 3]]] \
            [+ [* [h $i 3] [h $j 2]] [* [h $i 2] [h $j 3]]] \
            [* [h $i 3] [h $j 3]]
    }

    set V [list \
               [v 1 2] \
               [sub [v 1 1] [v 2 2]]]
    return $V
}

set V [concat {*}[lmap H $Hs {processHomography $H}]]

# Solve Vb = 0:
lassign [::math::linearalgebra::eigenvectorsSVD [matmul [transpose $V] $V]] eigenvectors eigenvalues
set b [lindex $eigenvectors [lindex [lsort -real -indices $eigenvalues] 0]]
puts $b
puts "Vb = [matmul $V $b]"

# Compute camera intrinsic matrix A:
lassign $b B11 B12 B22 B13 B23 B33
set v0 [expr {($B12*$B13 - $B11*$B23) / ($B11*$B22 - $B12*$B12)}]
set lambda [expr {$B33 - ($B12*$B13 + $v0*($B12*$B13 - $B11*$B23))/$B11}]
puts "lambda $lambda -- B11 $B11"
set alpha [expr {sqrt($lambda/$B11)}]
set beta [expr {sqrt($lambda*$B11/($B11*$B22 - $B12*$B12))}]
set gamma [expr {-$B12*$alpha*$alpha*$beta/$lambda}]
set u0 [expr {$gamma*$v0/$beta - $B13*$alpha*$alpha/$lambda}]
