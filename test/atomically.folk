When stuff should run {
    Claim we started running
    sleep 1
    Claim we are done
}
When -atomically whatever {
    Claim stuff should run
}
Claim whatever

# FIXME: do an atomicity-respecting Query! for the earlier
# Claims. they shouldn't show up
When we started running {
    assert {[llength [Query! -atomically stuff should run]] == 0}
    assert {[llength [Query! -atomically we started running]] == 0}

    sleep 2
    assert {[llength [Query! -atomically stuff should run]] == 1}
    assert {[llength [Query! -atomically we started running]] == 1}

    Exit! 0
}
