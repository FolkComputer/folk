When display /disp/ has width /w/ height /h/ {
    When the clock time is /t/ {
        Wish to draw a dashed line with points [list [list 0 0] [list $w 0] [list $w $h] [list 0 $h] [list 0 0]] color white width 10 dashlength 40 dashoffset [expr {fmod($t, 10)*-120}]
    }
}

# HACK: we need one image that never gets destroyed to act as a
# placeholder.
When the page is out {
    Wish the GPU creates writable image TEST with width 1024 height 1024
    Wish the GPU draws pipeline "fillTriangle" onto image TEST \
        with arguments [list {
            {1 0 0}
            {0 1 0}
            {0 0 1}
        } {-1 -1} {1 -1} {-1 1} {0.5 0 0.5 0.5}]

    Wish the GPU draws pipeline "fillTriangle" onto image TEST \
        with arguments [list {
            {1 0 0}
            {0 1 0}
            {0 0 1}
        } {1 -1} {1 1} {-1 1} {1 0 1 0.5}]
}

When the GPU library is /gpuLib/ &\
     the GPU writable image library is /gpuDrawableLib/ &\
     the GPU creates writable image TEST as /surf/ {

    puts ON---------------
    set testim [$gpuDrawableLib gpuImage $surf]
    set a [list -0.5 -0.5]
    set b [list 0.5 -0.5]
    set c [list 0.5 0.5]
    set d [list -0.5 0.5]
    Wish the GPU draws pipeline "image" with arguments \
        [list [list [$gpuLib getWidth] [$gpuLib getHeight]] \
             $testim $a $b $c $d]
}

##############

Assert! the page is out
When {
    sleep 5
    Retract! the page is out
}

##############

# When {
#     sleep 5
#     __conclude 0
# }

Assert! when /__this/ has program code /__programCode/ {
    SayWithSource $__this 1 0 {} \
        when $__programCode with environment [list [list this $__this]]
} with environment {}
local proc LoadProgram! {programFilename} {
    set fp [open $programFilename r]
    HoldStatement! (keep 100ms) (on boot.folk) [list $programFilename code] \
        [list boot.folk claims $programFilename has program code [read $fp]]
    close $fp
}

apply {{} {
    LoadProgram! virtual-programs/gpu/images.folk
    LoadProgram! virtual-programs/gpu/writable-images.folk
    LoadProgram! virtual-programs/draw/color-map.folk
    LoadProgram! virtual-programs/draw/dashed-line.folk
    LoadProgram! virtual-programs/draw/fill.folk
    LoadProgram! virtual-programs/draw/image.folk
    LoadProgram! virtual-programs/gpu-fns.folk
    source virtual-programs/gpu.folk
}}

