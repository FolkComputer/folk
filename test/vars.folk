proc vars {newvars} {
    lappend code $newvars
    regsub -all -line {/\*.*?\*/} $newvars "" newvars
    regsub -all -line {//.*$} $newvars "" newvars
    regsub -all {=[^;]*;} $newvars "" newvars
    regsub -all {__thread \w+} $newvars {{\0}} newvars
    set newvars [string map {";" ""} $newvars]

    foreach {vartype varname} $newvars {
        if {[dict exists $vars $varname]} {
            error "var already exists: $varname"
        }
        dict set vars $vartype $varname

        puts "$vartype* ${varname}__ptr = ($vartype*) 0x40404"
        puts "#define $varname (*(${varname}__ptr))"
    }
}
vars {
    VkInstance instance;
    VkPhysicalDevice physicalDevice;
    VkPhysicalDeviceFeatures physicalDeviceFeatures;
    VkDevice device;

    uint32_t computeQueueFamilyIndex;
    uint32_t graphicsQueueFamilyIndex = UINT32_MAX;

    pthread_mutex_t graphicsQueueMutex;
    VkQueue graphicsQueue;
    VkQueue presentQueue;
    VkQueue computeQueue;

    VkRenderPass renderPass;

    VkSwapchainKHR swapchain;
    uint32_t swapchainImageCount;
    VkFramebuffer* swapchainFramebuffers;
    VkExtent2D swapchainExtent;

    __thread VkCommandPool commandPool = 0;

    VkCommandBuffer commandBuffer;
    uint32_t imageIndex;

    VkSemaphore imageAvailableSemaphore;
    VkSemaphore renderFinishedSemaphore;
    VkFence inFlightFence;
}
