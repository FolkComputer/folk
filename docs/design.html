<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon -->
  <title>Design | Folk Computer</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
<h2 id="high-level-design">High-level design</h2>
<p>Natural-language Datalog reactive database, implemented in a mixture
of Tcl and embedded chunks of C.</p>
<p>Statements (Claim, Wish, When) build a dependency graph that gets
incrementally updated as old statements are removed and new statements
are added.</p>
<p>(for example, every frame, old statements of AprilTag locations are
removed and new AprilTag locations are added, and everything
downstream of those locations will update)</p>
<p>Custom C &#39;FFI&#39; is used to embed C in Tcl. Most hardware interface
(camera, projector/graphics rendering, soon keyboard) is done in
inline C that compiles and gets dynamically loaded at runtime.</p>
<p>Statements are indexed by a custom trie that goes word by word (also
implemented in C), so you can match with wildcards in any position in
a statement.</p>
<h2 id="why-tcl-from-question-on-discord-wip-">Why Tcl? (from question on Discord, WIP)</h2>
<p>Tcl question i&#39;ve wanted to write about before. it&#39;s a little bit
accidental in that the current system grew out of a bunch of older Tcl
and C prototypes.</p>
<p>I think for a system like this, you want a language with extensible
syntax (that can at minimum express the natural-language-Datalog
constructs as fluently as built-in language constructs) and that has
decent interop with C. Tcl fits the bill pretty well. (and it has a
GUI toolkit and a bunch of other niceties)</p>
<p>Lua, LuaJIT, some Scheme variant, Duktape, or QuickJS would probably
be ok, with different tradeoffs for each (Lua and JS you don&#39;t get
syntax extensibility out of the box so you need to do that yourself,
in Lua you have to hook the parser, you&#39;d have to make sure your new
constructs compose ok with built-in constructs etc, it&#39;s hard to
iterate on them; a lot of JS runtimes like Node have terrible C
interop stories so you&#39;d have to be a wizard to do that stuff; Scheme
you probably don&#39;t want to be writing on a bare-bones tabletop editor;
etc)</p>
<p>oh, and Tcl also has very good threading, much better than any other
scripting language; i think that&#39;s actually a really big plus. (this
is for a few reasons -- all Tcl datatypes and code are easy to
network-serialize and ship around, the syntax for embedded Tcl code is
nice since it&#39;s just a multiline string, Tcl has a good built-in
multithreading library)</p>
<p>in general, Tcl also supports the &#39;polyglot&#39; way of doing things
pretty well, where you can have different sublanguages embeded into
your Tcl code just inside curly braces.</p>
<h3 id="non-goals-wip-">Non-goals (WIP)</h3>
<ul>
<li><p>ability to reuse existing API knowledge (HTML/DOM, JS canvas,
terminal I/O): none of this behavior is idiomatic for physical
computing</p>
</li>
<li><p>portability to Web: if you&#39;re setting up a camera and projector rig
in your space, you are probably willing to run a native app</p>
</li>
</ul>
</body>
</html>